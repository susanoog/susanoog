

# 環境に対して自動最適化する高性能通信基盤

## 概要A

- 環境に対して自動最適化する高性能通信基盤
- ルータやスイッチをデプロイする基盤を開発
- ルータやFirewallなどのネットワーク機能(NF)に対し
  スレッドベースの最適化を動的に行うことで
  数百万円の安価な汎用PCとソフトウェアでNFVを高性能に実現
- コンセプト
	- 環境情報から自動最適化
	- 複数NFのデプロイするNFV基盤 (no VM)


## 背景

- 昨今の通信業界の概念
	- NFV
		- ネットワーク機能(NF)を汎用PC上の仮想的(ソフト)に実現
	- サービスチェイニング
		- 複数のNFを数珠繋ぎ. 高機能なNFとみなす
	- ソフトウェアのほうが圧倒的にフレキシブル。性能に関しては....
- ハードウェア vs ソフトウェア
	- ハードウェア実装
		- ほぼ全ての処理はAsicで処理
		- 高性能/高安定/高価 の三高
	- ソフトウェア実装
		- DPDKの登場により一気に高性能化
			- パケット処理に特化した専用アプローチ
			- 専用機器に匹敵する性能を実現
		- フレキシブル
- DPDKの紹介
	- 性能維持のためにkernelとは関わらない (もちろん連携も可)
	- CPUの論理コアを1つのスレッドで占有
	- ユーザランド上で独自のポーリング専用NICドライバ
	- Hugepagesを用いた独自のメモリ管理
	- 用途例
		- ルータ (ex, Brocade Vyatta)
		- Openflowスイッチ
		- 2017.6時点のアカデミアでの最速はBGP full route 145Gbps
- DPDKを用いて高性能NFを実装するには？
	- NFの実装に必要な知識
		- あたり前だが実装するプロトコルの知識
	- 高性能化に必要な知識
		- 並列分散処理
		- ソフトウェアパイプライン
		- メモリコピー
		- 排他制御
		- パケット処理に対する愛
	- 性能計測をしながらソフトウェアパイプラインの最適化,
		NICの構成変更などをたくさん試して無駄を減らす
	- 要するに超楽しいけど大変
- ひらめき
	- DPDKはNFの実装に対してもっとも無駄のないようにに設計されている
	- NFが複数に増えたらVM上でDPDK NFを実装 -> だめでは
	- VM使わないでやろう
- まとめ
	- コンセプト
		- 環境情報から自動最適化
		- 複数NFのデプロイするNFV基盤 (no VM)
	- 環境情報
		- NICのスループット
		- スレッドの数, 遅延
		- 空きCPUの個数
	- チューニング内容
		- green/native スレッド
		- スレッドの多重度
		- NICチューニング
	- ユーザ(NF開発者)の実装部分
		- NF = {スレッドの集合, IOポート, 最低限のpipeline情報}
		- ソフトウェアパイプラインの最適化はしない
	- Callenge: 限界まで無駄のないソフトウェアパイプライン


## 具体例

- トラフィックが増えたタイミングで発火する自動最適化エンジン
- それを実装したプロトタイプのデモ


# Feedback

- FPGAを用いたアプローチ
	- 処理の特徴
		- FPGA向き: stream処理
		- CPU 向き: 配列など向き
	- 着物の人, Fujitsuの黒眼鏡の人(青シャツ)
	- reactive programing
	- データフローグラフの最適化 (つかえる)
	- 処理の実行方式の多態性
	- 型推論の実装
	- 高位合成系の実装
	- python実装
		- Polyphony
		- PyVerilog
		- PyCoRAM
		- Veriloggen
		- MyHDL

複数の{BPFをチェイニングしたもの}=NFとすると
各BPFをFPGAオフローディングできる->BPF NFをFPGA実装できる

Susanow
- どのようにトレードオフを切るのかをよく考えなさい by RKX
- ScyllaDBのチューニングみなさい
- もし、この問題が解決できるのだとすれば、個人の作った与信の無いプロダクトを、
  工場のようなミッションクリティカルな部分に入れるために何をするか？
	CISCOの値段にはCISCO保険みたいな部分も含まれている。 by 久池井淳 氏


Facebookより
- NFVでVMごとにDPDKを動かすのはむだという話かな?(rkx)
  -> そうです.VMオーバヘッドもしりたい
- これでどのくらい性能向上するんだろう(k)
  -> 性能向上はしない.バニラDPDKと勝負
- なんで1コアに張り付いているかを説明したほうがいい(rkx)
- Peeringルータとかのための(fuji)
- juniper高いのでできればつかいたい(fuji)
- IoT GWとして個社ニーズがある (kuchii)
- Google, Facebook, Microsoftも自分たちでケーブル引く時代(fuji)
- Google Edge Network
- SORACOMもSDNですよね
- ニコニコで採用検討したい(natsuno)
- 海底ケーブルマップhttps://www.submarinecablemap.com/(fuji)
- 工場一個で100G必要な時代はすぐ来る世界
- Tier1しらべbyあきみち http://www.geekpage.jp/blog/?id=2009%2F10%2F20%2F1 (syudo)
- IPv4 full route は、今 67万経路くらい。http://www.cidr-report.org/as2.0/ (syudo)
- AEセンサー1個だけでも1Mとか取って、そのセンサーが数千～数万必要な世界なので、
  今のIoTの世界はセンサーにかかるCAPEXと同じかそれ以上のコストをネットワークが
	必要としているので、これを削るアプローチはニーズがある。 (kuchii)
- し、この問題が解決できるのだとすれば、個人の作った与信の無いプロダクトを、
  工場のようなミッションクリティカルな部分に入れるために何をするか？というところ
  CISCOの値段にはCISCO保険みたいな部分も含まれている。 (kuchii)
- ハイパーバイザを捨ててしまって、完全にDPDK baseでやると全体最適化的にはどうなの？
  と質問で聞きましたが、これに関してはscyllaDBのチューニングとか見ると良いかも。(rkx)


